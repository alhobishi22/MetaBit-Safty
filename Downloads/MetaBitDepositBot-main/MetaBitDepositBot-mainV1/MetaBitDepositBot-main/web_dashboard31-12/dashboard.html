<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة المعلومات</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css" rel="stylesheet">
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: none;
        }
        .stats-card {
            text-align: center;
            padding: 20px;
        }
        .stats-card h2 {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
        }
        .table th {
            font-weight: 600;
            background-color: #f8f9fa;
        }
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
    </style>
</head>
<body>
    <!-- مؤشر التحميل -->
    <div class="loading" id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">جاري التحميل...</span>
        </div>
    </div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>لوحة المعلومات</h2>
            <button class="btn btn-outline-primary" onclick="updateDashboard()">
                <i class="mdi mdi-refresh"></i> تحديث
            </button>
        </div>
        
        <!-- بطاقات الإحصائيات -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white stats-card">
                    <i class="mdi mdi-chart-bar" style="font-size: 2rem;"></i>
                    <h5>إجمالي العمليات</h5>
                    <h2 id="total-count">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white stats-card">
                    <i class="mdi mdi-check-circle" style="font-size: 2rem;"></i>
                    <h5>العمليات المكتملة</h5>
                    <h2 id="completed-count">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-dark stats-card">
                    <i class="mdi mdi-clock" style="font-size: 2rem;"></i>
                    <h5>العمليات المعلقة</h5>
                    <h2 id="pending-count">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white stats-card">
                    <i class="mdi mdi-close-circle" style="font-size: 2rem;"></i>
                    <h5>العمليات الفاشلة</h5>
                    <h2 id="failed-count">0</h2>
                </div>
            </div>
        </div>

        <!-- المبالغ الإجمالية -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="mdi mdi-cash-multiple text-success" style="font-size: 2rem;"></i>
                        <h5 class="card-title">إجمالي المبالغ المكتملة (USD)</h5>
                        <h3 id="completed-amount">$0.00</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="mdi mdi-cash-clock text-warning" style="font-size: 2rem;"></i>
                        <h5 class="card-title">إجمالي المبالغ المعلقة (USD)</h5>
                        <h3 id="pending-amount">$0.00</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- جدول آخر العمليات -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="mdi mdi-table"></i>
                    آخر العمليات
                </h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>معرف العملية</th>
                                <th>المستخدم</th>
                                <th>العملة</th>
                                <th>المبلغ</th>
                                <th>الحالة</th>
                                <th>التاريخ</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table">
                            <!-- سيتم ملء هذا الجزء بواسطة JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = 'http://localhost:8000/api/dashboard';

        // دالة لعرض مؤشر التحميل
        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        // دالة لإخفاء مؤشر التحميل
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // دالة لتنسيق المبالغ
        function formatAmount(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // دالة لتنسيق التاريخ
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = {
                year: 'numeric',
                month: 'numeric',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            };
            return new Intl.DateTimeFormat('ar-SA', options).format(date);
        }

        // دالة لتحديث الإحصائيات
        async function updateStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`);
                if (!response.ok) throw new Error('فشل جلب الإحصائيات');
                
                const data = await response.json();
                
                document.getElementById('total-count').textContent = data.total_count;
                document.getElementById('completed-count').textContent = data.completed_count;
                document.getElementById('pending-count').textContent = data.pending_count;
                document.getElementById('failed-count').textContent = data.failed_count;
                document.getElementById('completed-amount').textContent = formatAmount(data.completed_amount);
                document.getElementById('pending-amount').textContent = formatAmount(data.pending_amount);
            } catch (error) {
                console.error('خطأ في تحديث الإحصائيات:', error);
                alert('حدث خطأ أثناء تحديث الإحصائيات');
            }
        }

        // دالة لتحديث جدول العمليات
        async function updateTransactions() {
            try {
                const response = await fetch(`${API_BASE_URL}/recent-transactions`);
                if (!response.ok) throw new Error('فشل جلب العمليات');
                
                const transactions = await response.json();
                const tbody = document.getElementById('transactions-table');
                tbody.innerHTML = '';
                
                transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${tx.withdrawal_id}</td>
                        <td>${tx.user_id}</td>
                        <td>${tx.currency}</td>
                        <td>${formatAmount(tx.amount)}</td>
                        <td>
                            <span class="badge bg-${
                                tx.status === 'completed' ? 'success' :
                                tx.status === 'pending' ? 'warning' :
                                'danger'
                            }">
                                ${tx.status}
                            </span>
                        </td>
                        <td>${formatDate(tx.created_at)}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('خطأ في تحديث العمليات:', error);
                alert('حدث خطأ أثناء تحديث العمليات');
            }
        }

        // دالة لتحديث لوحة المعلومات بالكامل
        async function updateDashboard() {
            showLoading();
            try {
                await Promise.all([
                    updateStats(),
                    updateTransactions()
                ]);
            } finally {
                hideLoading();
            }
        }

        // تحديث البيانات عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', updateDashboard);
        
        // تحديث دوري كل دقيقة
        setInterval(updateDashboard, 60000);
    </script>
</body>
</html>