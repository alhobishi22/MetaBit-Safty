{% extends "base.html" %}

{% block title %}التحليلات{% endblock %}

{% block extra_css %}
<style>
    .chart-card {
        height: 400px;
        margin-bottom: 2rem;
    }
    .stats-card {
        height: 150px;
        margin-bottom: 1rem;
    }
    .plotly-graph {
        width: 100%;
        height: 100%;
    }
    .stats-value {
        font-size: 2rem;
        font-weight: bold;
        color: #2c3e50;
    }
    .stats-label {
        color: #7f8c8d;
        font-size: 0.9rem;
    }
    .trend-up {
        color: #27ae60;
    }
    .trend-down {
        color: #c0392b;
    }
    .chart-filters {
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">التحليلات</h2>
        <div>
            <button class="btn btn-outline-primary me-2" id="exportBtn">
                <i class="bi bi-download"></i>
                تصدير البيانات
            </button>
            <button class="btn btn-outline-primary" onclick="location.reload()">
                <i class="bi bi-arrow-clockwise"></i>
                تحديث
            </button>
        </div>
    </div>

    <!-- بطاقات الإحصائيات -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-value">{{ total_amount | format_currency }}</div>
                    <div class="stats-label">إجمالي المبالغ (USD)</div>
                    <div class="trend {{ 'trend-up' if amount_trend > 0 else 'trend-down' }}">
                        <i class="bi {{ 'bi-arrow-up' if amount_trend > 0 else 'bi-arrow-down' }}"></i>
                        {{ amount_trend }}% مقارنة بالأمس
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-value">{{ total_transactions }}</div>
                    <div class="stats-label">عدد العمليات</div>
                    <div class="trend {{ 'trend-up' if transaction_trend > 0 else 'trend-down' }}">
                        <i class="bi {{ 'bi-arrow-up' if transaction_trend > 0 else 'bi-arrow-down' }}"></i>
                        {{ transaction_trend }}% مقارنة بالأمس
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-value">{{ success_rate }}%</div>
                    <div class="stats-label">نسبة نجاح العمليات</div>
                    <div class="trend {{ 'trend-up' if success_trend > 0 else 'trend-down' }}">
                        <i class="bi {{ 'bi-arrow-up' if success_trend > 0 else 'bi-arrow-down' }}"></i>
                        {{ success_trend }}% مقارنة بالأمس
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="stats-value">{{ avg_amount | format_currency }}</div>
                    <div class="stats-label">متوسط قيمة العملية</div>
                    <div class="trend {{ 'trend-up' if avg_trend > 0 else 'trend-down' }}">
                        <i class="bi {{ 'bi-arrow-up' if avg_trend > 0 else 'bi-arrow-down' }}"></i>
                        {{ avg_trend }}% مقارنة بالأمس
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- مخطط المبالغ اليومية -->
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-graph-up"></i>
                            المبالغ اليومية (USD)
                        </h5>
                        <div class="chart-filters">
                            <select class="form-select form-select-sm d-inline-block w-auto" id="amountChartPeriod">
                                <option value="7">آخر 7 أيام</option>
                                <option value="30" selected>آخر 30 يوم</option>
                                <option value="90">آخر 3 أشهر</option>
                            </select>
                        </div>
                    </div>
                    <div id="amountChart" class="plotly-graph"></div>
                </div>
            </div>
        </div>

        <!-- مخطط عدد العمليات -->
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bar-chart"></i>
                            عدد العمليات اليومية
                        </h5>
                        <div class="chart-filters">
                            <select class="form-select form-select-sm d-inline-block w-auto" id="countChartPeriod">
                                <option value="7">آخر 7 أيام</option>
                                <option value="30" selected>آخر 30 يوم</option>
                                <option value="90">آخر 3 أشهر</option>
                            </select>
                        </div>
                    </div>
                    <div id="countChart" class="plotly-graph"></div>
                </div>
            </div>
        </div>

        <!-- مخطط توزيع العملات -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-pie-chart"></i>
                        توزيع العملات المشفرة
                    </h5>
                    <div id="cryptoDistChart" class="plotly-graph"></div>
                </div>
            </div>
        </div>

        <!-- مخطط حالات العمليات -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="bi bi-pie-chart"></i>
                        توزيع حالات العمليات
                    </h5>
                    <div id="statusDistChart" class="plotly-graph"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تهيئة المخططات
        const amountData = JSON.parse('{{ plot_amount | safe }}');
        const countData = JSON.parse('{{ plot_count | safe }}');
        const cryptoDistData = JSON.parse('{{ plot_crypto_dist | safe }}');
        const statusDistData = JSON.parse('{{ plot_status_dist | safe }}');
        
        // تخصيص مظهر المخططات
        const layout = {
            font: { family: 'Arial, sans-serif' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            margin: { t: 30, r: 30, b: 50, l: 50 },
            showlegend: true,
            xaxis: {
                gridcolor: '#eee',
                zeroline: false
            },
            yaxis: {
                gridcolor: '#eee',
                zeroline: false
            }
        };

        // إنشاء المخططات
        Plotly.newPlot('amountChart', amountData.data, {...amountData.layout, ...layout});
        Plotly.newPlot('countChart', countData.data, {...countData.layout, ...layout});
        Plotly.newPlot('cryptoDistChart', cryptoDistData.data, {...cryptoDistData.layout, ...layout});
        Plotly.newPlot('statusDistChart', statusDistData.data, {...statusDistData.layout, ...layout});

        // معالجة تغيير الفترة الزمنية
        document.getElementById('amountChartPeriod').addEventListener('change', function(e) {
            updateChart('amount', e.target.value);
        });

        document.getElementById('countChartPeriod').addEventListener('change', function(e) {
            updateChart('count', e.target.value);
        });

        // تحديث المخطط
        function updateChart(type, days) {
            fetch(`/analytics/data?type=${type}&days=${days}`)
                .then(response => response.json())
                .then(data => {
                    if (type === 'amount') {
                        Plotly.newPlot('amountChart', data.data, {...data.layout, ...layout});
                    } else {
                        Plotly.newPlot('countChart', data.data, {...data.layout, ...layout});
                    }
                });
        }

        // إعادة تعيين حجم المخططات عند تغيير حجم النافذة
        window.addEventListener('resize', function() {
            Plotly.Plots.resize('amountChart');
            Plotly.Plots.resize('countChart');
            Plotly.Plots.resize('cryptoDistChart');
            Plotly.Plots.resize('statusDistChart');
        });

        // تصدير البيانات
        document.getElementById('exportBtn').addEventListener('click', function() {
            window.location.href = '/analytics/export';
        });

        // تحديث تلقائي كل 5 دقائق
        setInterval(function() {
            location.reload();
        }, 300000);
    });
</script>
{% endblock %}